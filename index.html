<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tresure Deck</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background:#000; color:white; font-family:sans-serif; margin:0;
padding:0; }
header { text-align:center; padding:10px; background:#111; }
.filters { padding:10px; }
.accordion-button, .accordion-body { background-color:#1a1a1a; color:#fff;
border:1px solid #fff; }
.accordion-button:focus { box-shadow:none; }
.accordion-button:not(.collapsed) { background-color:#0d1b3d; color:#fff; }
.filter-content label { display:inline-flex; align-items:center;
justify-content:center; min-width:0; margin:3px; padding:6px 10px;
border:1px solid #fff; border-radius:6px; cursor:pointer; background:#1a1a1a;
color:#fff; font-size:14px; transition: all 0.2s ease; white-space:nowrap; }
.filter-content label.selected { background:#fff; color:#000;
border-color:#fff; transform:scale(0.96); }
.filter-content label:active { transform: scale(0.92); opacity:0.9; }
#seriesFilterGroup { display:grid; grid-template-columns:repeat(3,1fr);
gap:4px; }
#colorFilterGroup,#rarityFilterGroup,#attributeFilterGroup,
#parallelFilterGroup { display:grid; grid-template-columns:repeat(2,1fr);
gap:4px; }
.filter-content label input { display:none; }
.display-toggle-container { display:flex; justify-content:space-between;
align-items:center; flex-wrap:wrap; margin-top:4px; }
.display-toggle-left { display:flex; gap:4px; flex-wrap:wrap; }
.display-toggle-btn,#ownedBtn, #unownedBtn { border:1px solid #fff;
background:transparent; color:#fff; border-radius:6px; padding:4px 8px;
font-size:14px; cursor:pointer; transition:0.2s; }
.display-toggle-btn:hover,#ownedBtn:hover, #unownedBtn:hover { background:#fff;
color:#0d1b3d; }
.display-toggle-btn.active,#ownedBtn.active, #unownedBtn.active {
background:#fff; color:#0d1b3d; }
.card-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px;
padding:10px; }
.card-list { display:block; padding:10px; }
.card { background:#1a1a1a; border-radius:8px; padding:4px 8px;
text-align:center; cursor:pointer; transition:0.2s; margin-bottom:8px;
position:relative; }
.card:hover { transform:scale(1.05); }
.card img { width:100%; border-radius:4px; }
.card-list .card { display:flex; flex-direction:row; align-items:stretch;
gap:4px; margin-bottom:8px; padding:2px 0; background:#1a1a1a;
border-radius:6px; cursor:pointer; min-height:40px; }
.color-bar { width:5px; flex-shrink:0; border-radius:2px;
align-self:stretch; }
.card-content { flex-grow:1; padding:4px 8px; display:flex;
flex-direction:column; justify-content:center; }
.list-top, .list-bottom {
    display:flex;
    align-items:center;
    gap:6px;
    flex-wrap: nowrap;
    width: 100%;
}
.list-top .attr, .list-bottom .rarity {
    width:40px;
    text-align:center;
    border:1px solid white;
    border-radius:4px;
    padding:2px 4px;
    flex-shrink: 0;
}
.list-top .code, .list-bottom .name {
    flex: 1;
    min-width: 0;
    margin-left:8px;
    text-align:left;
    font-size:15px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}
.card-grid .info *, .card-list .card-content * { color:#fff !important; }
.badge { position:absolute; background:#2ecc71; color:white; font-size:0.7em;
font-weight:bold; padding:3px 6px; border-radius:5px; }
.card-grid .badge { top:8px; left:8px; }
.card-list .badge { bottom:8px; right:8px; top:auto; left:auto; }
.card-grid .info { font-size:12px; }
.card-grid .info div { font-size:11px; }
.bottom-nav { position:fixed; bottom:0; left:0; width:100%; background:#111;
display:flex; border-top:1px solid #444; }
.bottom-nav button { flex:1; padding:10px; font-size:14px; border:none;
background:none; color:#fff; cursor:pointer; }
.bottom-nav button.active { background:#fff; color:#0d1b3d; }
.bottom-nav button:hover { background:#333; }
#totalValue { text-align:center; margin-top:100px; color:#38b897;
font-size:60px; }
#debugOutput { position:fixed; top:0; right:0; background:#111; color:#ff0;
max-height:200px; overflow:auto; font-size:12px; padding:4px; white-space:
pre-wrap; z-index: 9999; }
#rarityTable {
  background-color: rgba(30,30,30,0.9);
  color: #fff;
}
#rarityTable th, #rarityTable td {
  border-color: #555;
}
#rarityTable tr.total-row {
  background-color: #333;
  font-weight: normal;
}
.stats-table tfoot td {
  font-weight: normal !important;
}
.stats-table th,
.stats-table td {
  padding: 8px;
  border: 1px solid #444;
  text-align: center !important;
  vertical-align: middle !important;
}
#rarityTable th,
#rarityTable td,
#colorTable th,
#colorTable td {
  text-align: center !important;
  vertical-align: middle !important;
}
#searchInput {
  font-size: 16px;
}
</style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d1b3d">


</head>
<body>

<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Chart</h5>
        <button type="button" class="btn-close btn-close-white"
data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <h5 id="historyCardName" style="margin:20px 0; font-weight:bold;"></h5>
        <div id="chart-container" style="height:250px;"></div>
      </div>
    </div>
  </div>
</div>

<header><h1>Tresure Deck</h1></header>

<div id="searchPage">
<div class="filters">
<div class="mb-2" style="display:flex; align-items:center; gap:6px;">
  <label style="flex-grow:1;">カードタイプ:
    <select id="typeFilter" class="form-select form-select-sm">
      <option value="normal">通常カード</option>
      <option value="don">ドン!!カード</option>
    </select>
  </label>
  <button id="settingsBtn" class="display-toggle-btn"
style="flex-shrink:0;">Setting</button>
</div>

  <div class="accordion" id="filterAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button"
data-bs-toggle="collapse" data-bs-target="#seriesCollapse">シリーズ</button>
      </h2>
      <div id="seriesCollapse" class="accordion-collapse collapse"
data-bs-parent="#filterAccordion">
        <div class="accordion-body filter-content" id="seriesFilterGroup"></div>
      </div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button"
data-bs-toggle="collapse" data-bs-target="#colorCollapse">色</button>
      </h2>
      <div id="colorCollapse" class="accordion-collapse collapse"
data-bs-parent="#filterAccordion">
        <div class="accordion-body filter-content" id="colorFilterGroup"></div>
      </div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button"
data-bs-toggle="collapse" data-bs-target="#rarityCollapse">レアリティ</button>
      </h2>
      <div id="rarityCollapse" class="accordion-collapse collapse"
data-bs-parent="#filterAccordion">
        <div class="accordion-body filter-content"
id="rarityFilterGroup"></div>
      </div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button"
data-bs-toggle="collapse"
data-bs-target="#attributeCollapse">属性</button>
      </h2>
      <div id="attributeCollapse" class="accordion-collapse collapse"
data-bs-parent="#filterAccordion">
        <div class="accordion-body filter-content"
id="attributeFilterGroup"></div>
      </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button"
data-bs-toggle="collapse"
data-bs-target="#parallelCollapse">
                パラレル
            </button>
        </h2>
        <div id="parallelCollapse" class="accordion-collapse collapse"
data-bs-parent="#filterAccordion">
            <div class="accordion-body filter-content"
id="parallelFilterGroup"></div>
        </div>
    </div>
  </div>

  <div class="mt-2 mb-2">
    <div style="position:relative; display:flex; align-items:center;">
  <input type="text" id="searchInput" class="form-control form-control-sm mb-1"
placeholder="名前 / コードで検索" style="flex:1; padding-right:30px;">
  <button id="clearSearch"
          style="
            position:absolute;
            right:8px;
            top:50%;
            transform:translateY(-50%);
            background:#444;
            border:none;
            color:#fff;
            font-size:16px;
            padding:0 6px;
            border-radius:4px;
            cursor:pointer;
          ">×</button>
</div>

    <div class="mb-2" style="display:flex; align-items:center;">
        <label for="sortSelector" style="font-size:14px; margin-right:8px; flex-shrink:0;">ソート:</label>
        <select id="sortSelector" class="form-select form-select-sm" style="width:auto; display:inline-block;">
            <option value="default">デフォルト (コード順)</option>
            <option value="code_asc">コード (昇順)</option>
            <option value="code_desc">コード (降順)</option>
            <option value="rarity_asc">レアリティ (高→低)</option>
            <option value="rarity_desc">レアリティ (低→高)</option>
        </select>
    </div>

    <div class="display-toggle-container">
      <div class="display-toggle-left">
        <button id="gridBtn" class="display-toggle-btn">Grid</button>
        <button id="listBtn" class="display-toggle-btn active">List</button>
      </div>
      <button id="allBtn" class="display-toggle-btn active">All</button>
      <button id="ownedBtn">Collected</button>
      <button id="unownedBtn">Uncollected</button>
    </div>
  </div>

  <div id="activeFilters"></div>
</div>

<div id="ownedCount" class="text-center my-1"></div>
<div class="text-center">
  <button id="statsBtn" class="display-toggle-btn" data-bs-toggle="modal"
data-bs-target="#statsModal">
    統計を見る
  </button>
</div>
<div id="cardGrid" class="card-list"></div>
</div>

<div id="collectionPage" style="display:none; padding:10px;">
<h3 id="totalValue" style="margin-top:10px; text-align:center;">0</h3>
<ul id="collectionList" style="list-style:none; padding:0; margin:0;"></ul>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background:#1a1a1a; color:#fff;">
      <div class="modal-header">
        <h5 class="modal-title">Setting</h5>
        <button type="button" class="btn-close btn-close-white"
data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex; flex-direction:column;
gap:8px;">
        <button id="debugToggleBtn" class="display-toggle-btn">Debug
OFF</button>
        <button id="confirmToggleBtn" class="display-toggle-btn
active">Collected 確認 ON</button>
        <button id="exportDataBtn" class="display-toggle-btn">データのエクスポート</button>
        <button id="copyDataBtn" class="display-toggle-btn"
style="display:none;">コピー</button>
        <textarea id="dataOutput" rows="5" class="form-control mt-3"
style="color:white; background:#333; display:none;" readonly></textarea>
        <button id="importDataBtn" class="display-toggle-btn">データのインポート</button>
      </div>

      <div class="modal-footer">
        <button type="button" class="display-toggle-btn"
data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="statsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="background:#1a1a1a; color:#fff;">
      <div class="modal-header">
        <h5 class="modal-title">Stats</h5>
        <button type="button" class="btn-close btn-close-white"
data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
  <h6 class="fw-bold mb-2">By Rarity</h6>
  <table class="table table-dark table-striped table-sm"
id="rarityTable">
  <thead>
    <tr>
      <th>Rarity</th>
      <th>All</th>
      <th>Owned</th>
      <th>Rate</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h6 class="fw-bold mt-4 mb-2">By Color</h6>
<table class="table table-dark table-striped table-sm"
id="colorTable">
  <thead>
    <tr>
      <th>Color</th>
      <th>All</th>
      <th>Owned</th>
      <th>Rate</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<pre id="debugOutput"></pre>

<script
src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.
js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// =========================================================================
// 定数定義 (保守性向上のため、重要な値はここに集約)
// =========================================================================
const RARITY_ORDER = ["L", "SEC", "SR", "R", "UC", "C", "P", "SP", "LEADER", "DON!!"];
const SERIES_ORDER = ["EB01", "EB02", "EB03", "EB04", "EB05"];
const COLOR_MAP = { "赤": "#f44336", "Red": "#f44336", "青": "#2196f3", "Blue": "#2196f3", "緑": "#4caf50", "Green": "#4caf50", "黄": "#ffeb3b", "Yellow": "#ffeb3b", "紫": "#9c27b0", "Purple": "#9c27b0" };

// =========================================================================
// グローバル変数
// =========================================================================
let allCards = { normal: [], don: [] }, cards = [], currentType = "normal", displayMode = "list";
let showOwnedOnly = false;
let showUnownedOnly = false;
let currentSort = "default";
let debugMode = false;
let confirmOwnedRemoval = true;

let bMap = {}; // id0 -> priceid
let cMap = {}; // priceid -> history
let latestMap = {}; // priceid -> latest price

// =========================================================================
// ヘルパー関数 (Owned状態とレアリティ順序)
// =========================================================================
function getUniqueKey(card) { 
    const typePrefix = currentType === "normal" ? "normal" : "don";
    return typePrefix + "_" + card.code + "_" + card.parallel + "_" + (Array.isArray(card.color) ? card.color.join("/") : card.color) + "_" + card.image_url; 
}
function isOwned(card) { return localStorage.getItem(getUniqueKey(card)) === "true"; }
function toggleOwned(card) {
    if (isOwned(card) && confirmOwnedRemoval) {
        if (!confirm(`「${card.name || card.code}」のCollectedを外しますか？`)) return;
    }
    localStorage.setItem(getUniqueKey(card), (!isOwned(card)).toString());
    renderCards(filterCards());
}

function getRarityIndex(rarity) {
    return RARITY_ORDER.indexOf(rarity) !== -1 ? RARITY_ORDER.indexOf(rarity) : 99;
}

// =========================================================================
// UI構築
// =========================================================================
function createCheckbox(container, value, labelText, color) {
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" value="${value}"><span>${labelText}</span>`;
    container.appendChild(label);
    const checkbox = label.querySelector("input");
    checkbox.addEventListener("change", () => {
        if (checkbox.checked) label.classList.add("selected");
        else label.classList.remove("selected");
        renderCards(filterCards());
        updateActiveFilters();
    });
}

function populateSeriesFilterUI() {
    const container = document.getElementById("seriesFilterGroup");
    container.innerHTML = "";
    const seriesSet = new Set(cards.map(c => c.code.split("-")[0]));
    const seriesArray = Array.from(seriesSet);
    
    seriesArray.sort((a, b) => {
        const iA = SERIES_ORDER.indexOf(a);
        const iB = SERIES_ORDER.indexOf(b);
        if (iA !== -1 && iB !== -1) return iA - iB;
        if (iA !== -1) return -1;
        if (iB !== -1) return 1;
        return a.localeCompare(b);
    });
    seriesArray.forEach(s => createCheckbox(container, s, s));
}

function populateColorFilterUI() { 
    const c = document.getElementById("colorFilterGroup"); c.innerHTML = ""; 
    const colorSet = new Set(cards.flatMap(c => Array.isArray(c.color) ? c.color : [c.color]).filter(Boolean));
    colorSet.forEach(cl => createCheckbox(c, cl, cl, COLOR_MAP[cl] || "#666")); 
}
function populateRarityFilterUI() { 
    const c = document.getElementById("rarityFilterGroup"); c.innerHTML = ""; 
    const rSet = new Set(cards.map(c => c.rarity).filter(r => r)); 
    RARITY_ORDER.forEach(r => { if (rSet.has(r)) createCheckbox(c, r, r); }); 
}
function populateAttributeFilterUI() { 
    const c = document.getElementById("attributeFilterGroup"); c.innerHTML = ""; 
    const aSet = new Set(cards.map(c => c.attribute).filter(a => a));
    aSet.forEach(a => createCheckbox(c, a, a)); 
}

function populateParallelFilterUI() {
    const container = document.getElementById("parallelFilterGroup");
    container.innerHTML = "";
    createCheckbox(container, "normal", "通常");
    createCheckbox(container, "parallel", "パラレル");
}

function updateActiveFilters() {
    const container = document.getElementById("activeFilters"); container.innerHTML = "";
    ["seriesFilterGroup", "colorFilterGroup", "rarityFilterGroup", "attributeFilterGroup", "parallelFilterGroup"].forEach(id => {
        document.querySelectorAll(`#${id} input:checked`).forEach(chk => {
            const tag = document.createElement("span");
            tag.textContent = (chk.value === "normal" ? "通常" : (chk.value === "parallel" ? "パラレル" : chk.value)) + " ×";
            tag.style.margin = "2px"; tag.style.padding = "2px 6px"; tag.style.border = "1px solid #fff"; tag.style.borderRadius = "4px"; tag.style.cursor = "pointer";
            tag.addEventListener("click", () => { chk.checked = false; chk.dispatchEvent(new Event('change')); });
            container.appendChild(tag);
        });
    });
}

// =========================================================================
// フィルタリングとソートのメインロジック
// =========================================================================
function filterCards() {
    const series = Array.from(document.querySelectorAll("#seriesFilterGroup input:checked")).map(c => c.value);
    const colors = Array.from(document.querySelectorAll("#colorFilterGroup input:checked")).map(c => c.value);
    const rarities = Array.from(document.querySelectorAll("#rarityFilterGroup input:checked")).map(c => c.value);
    const attributes = Array.from(document.querySelectorAll("#attributeFilterGroup input:checked")).map(c => c.value);
    const parallels = Array.from(document.querySelectorAll("#parallelFilterGroup input:checked")).map(c => c.value);
    const search = document.getElementById("searchInput").value.toLowerCase();

    const filtered = cards.filter(c => {
        if (series.length > 0 && !series.includes(c.code.split("-")[0])) return false;
        
        // 色のフィルタリング (OR条件に修正)
        if (colors.length > 0) {
            const cardColors = Array.isArray(c.color) ? c.color : [c.color].filter(Boolean);
            if (!colors.some(filterColor => cardColors.includes(filterColor))) return false;
        }

        if (rarities.length > 0 && !rarities.includes(c.rarity)) return false;
        
        // 属性のフィルタリング (OR条件に修正)
        if (attributes.length > 0) {
            const cardAttributes = Array.isArray(c.attribute) ? c.attribute : [c.attribute].filter(Boolean);
            if (!attributes.some(filterAttr => cardAttributes.includes(filterAttr))) return false;
        }
        
        if (parallels.length > 0) {
            const isNormal = parallels.includes("normal");
            const isParallel = parallels.includes("parallel");
            
            if (isNormal && !isParallel) {
                if (c.parallel !== "normal") return false;
            } else if (!isNormal && isParallel) {
                if (c.parallel === "normal") return false;
            }
        }
        
        if (search && !((c.name && c.name.toLowerCase().includes(search)) || (c.code && c.code.toLowerCase().includes(search)))) return false;
        
        if (showOwnedOnly && !isOwned(c)) return false;
        if (showUnownedOnly && isOwned(c)) return false;
        
        return true;
    });

    // ソート処理
    filtered.sort((a, b) => {
        if (currentSort === "default" || currentSort === "code_asc") {
            return a.code.localeCompare(b.code);
        } else if (currentSort === "code_desc") {
            return b.code.localeCompare(a.code);
        } else if (currentSort === "rarity_asc") {
            const indexA = getRarityIndex(a.rarity);
            const indexB = getRarityIndex(b.rarity);
            if (indexA !== indexB) {
                return indexA - indexB;
            }
            return a.code.localeCompare(b.code);
        } else if (currentSort === "rarity_desc") {
            const indexA = getRarityIndex(a.rarity);
            const indexB = getRarityIndex(b.rarity);
            if (indexA !== indexB) {
                return indexB - indexA;
            }
            return a.code.localeCompare(b.code);
        }
        return 0;
    });

    return filtered;
}

// =========================================================================
// カード表示の更新
// =========================================================================
function updateOwnedCount(filteredCards) {
    const owned = filteredCards.filter(isOwned).length;
    const total = filteredCards.length;
    const percent = total > 0 ? ((owned / total) * 100).toFixed(2) : "0.00";
    document.getElementById("ownedCount").textContent = `Collected: ${owned} / ${total} (${percent}%)`;
}

function renderCards(filtered) {
    const grid = document.getElementById("cardGrid");
    grid.innerHTML = "";
    updateOwnedCount(filtered);

    filtered.forEach(c => {
        const div = document.createElement("div");
        div.className = "card" + (isOwned(c) ? " Collected" : "");
        div.style.position = "relative";
        const badge = isOwned(c) ? `<span class="badge">COLLECTED</span>` : "";
        let parallelDisplay = (c.parallel && c.parallel !== "normal") ? "★" : "";

        // 価格
        let priceText = "";
        const priceid = bMap[String(c.id0)];
        if (c.id0 != null && priceid) {
            const data = latestMap[priceid];
            if (data != null) {
                priceText = `<div class="price">$${data.price}</div>`;
            } else {
                priceText = `<div class="price">―</div>`;
            }
        }

        // カード自体のクリックイベント
        div.addEventListener("click", () => {
            toggleOwned(c);
            if (debugMode) document.getElementById("debugOutput").textContent = JSON.stringify(c, null, 2);
        });

        if (displayMode === "grid") {
            div.innerHTML = `
                ${badge}
                <img src="${c.image_url || ''}" alt="${c.name || ''}">
                <div class="info">
                  <div>${c.code || ''}[${c.rarity || ''}]${parallelDisplay}</div>
                  <div>${c.name || ''}</div>
                  ${priceText}
                  <button class="display-toggle-btn history-btn" data-priceid="${priceid || ''}" data-bs-toggle="modal" data-bs-target="#historyModal">
                    履歴
                  </button>
                </div>`;
        } else {
            let rawColors = Array.isArray(c.color) ? c.color : [c.color];
            rawColors = rawColors.filter(Boolean);
            let barColors = rawColors.length > 0 ? rawColors.map(cl => COLOR_MAP[cl] || "#666") : ["#666"];
            let barStyle = barColors.length > 1 ? `background: linear-gradient(to bottom, ${barColors.join(",")});` : `background: ${barColors[0]};`;

            div.innerHTML = `<div class="card-content">
  <div class="list-top">
    <span class="attr">${c.attribute || "-"}</span>
    <span class="code">${c.code || ''}${parallelDisplay ? ` (${parallelDisplay})` : ''}</span>
    <div style="flex-shrink:0; display:flex; gap:4px; align-items:center;"> ${priceText}
      <button class="display-toggle-btn history-btn" data-priceid="${priceid || ''}" data-bs-toggle="modal" data-bs-target="#historyModal">
        DATA
      </button>
    </div>
  </div>
  <div class="list-bottom">
    <span class="rarity">${c.rarity || "-"}</span>
    <span class="name">${c.name || ""}</span>
    <div style="flex-shrink:0; margin-left:8px;"> ${badge}
    </div>
  </div>
</div>`;
        }

        div.querySelectorAll('.history-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });

        grid.appendChild(div);
    });
    grid.className = displayMode === "grid" ? "card-grid" : "card-list";
}

function setCards(type) {
    currentType = type; cards = allCards[type] || [];
    document.getElementById("searchInput").value = ""; 
    showOwnedOnly = false;
    showUnownedOnly = false;
    currentSort = "default";
    document.getElementById("sortSelector").value = "default"; 

    document.getElementById("allBtn").classList.add("active");
    document.getElementById("ownedBtn").classList.remove("active");
    document.getElementById("unownedBtn").classList.remove("active");
    populateSeriesFilterUI(); populateColorFilterUI(); populateRarityFilterUI(); populateAttributeFilterUI();
    populateParallelFilterUI();
    updateActiveFilters(); renderCards(filterCards());
}

// =========================================================================
// データ読み込みとイベントリスナー
// =========================================================================
Promise.all([
    fetch("Card_Data/Onepeace_Cards/cards.json").then(r => r.json()),
    fetch("Card_Data/Onepeace_Cards/don_cards.json").then(r => r.ok ? r.json() : []).catch(() => []),
    fetch("Card_Data/Onepeace_Cards/B.json").then(r => r.ok ? r.json() : []).catch(() => []),
    fetch("Card_Data/Onepeace_Cards/C.json").then(r => r.ok ? r.json() : []).catch(() => []),
    fetch("Card_Data/Onepeace_Cards/latestprice.json").then(r => r.ok ? r.json() : []).catch(() => [])
]).then(([normalCards, donCards, dataB, dataC, latestPrice]) => {
    allCards.normal = normalCards;
    allCards.don = donCards;
    bMap = Object.fromEntries(dataB.map(x => [String(x.id0), x.priceid]));
    cMap = Object.fromEntries(dataC.map(x => [x.priceid, x.price]));
    latestMap = Object.fromEntries(
        latestPrice.map(x => [x.priceid, { price: x.price, stats: x.stats }])
    );
    setCards("normal");
});

document.getElementById("sortSelector").addEventListener("change", (e) => {
    currentSort = e.target.value;
    renderCards(filterCards());
});

document.getElementById("typeFilter").addEventListener("change", e => setCards(e.target.value));

document.getElementById("gridBtn").addEventListener("click", () => { 
    displayMode = "grid"; 
    document.getElementById("gridBtn").classList.add("active");
    document.getElementById("listBtn").classList.remove("active");
    renderCards(filterCards()); 
});
document.getElementById("listBtn").addEventListener("click", () => { 
    displayMode = "list"; 
    document.getElementById("listBtn").classList.add("active");
    document.getElementById("gridBtn").classList.remove("active");
    renderCards(filterCards()); 
});

document.getElementById("allBtn").addEventListener("click", () => {
    showOwnedOnly = false;
    showUnownedOnly = false;
    document.getElementById("allBtn").classList.add("active");
    document.getElementById("ownedBtn").classList.remove("active");
    document.getElementById("unownedBtn").classList.remove("active");
    renderCards(filterCards());
});

document.getElementById("ownedBtn").addEventListener("click", () => {
    showOwnedOnly = !showOwnedOnly;
    showUnownedOnly = false;
    document.getElementById("ownedBtn").classList.toggle("active", showOwnedOnly);
    document.getElementById("unownedBtn").classList.remove("active");
    document.getElementById("allBtn").classList.remove("active");
    if (!showOwnedOnly) document.getElementById("allBtn").classList.add("active");
    renderCards(filterCards());
});

document.getElementById("unownedBtn").addEventListener("click", () => {
    showUnownedOnly = !showUnownedOnly;
    showOwnedOnly = false;
    document.getElementById("unownedBtn").classList.toggle("active", showUnownedOnly);
    document.getElementById("ownedBtn").classList.remove("active");
    document.getElementById("allBtn").classList.remove("active");
    if (!showUnownedOnly) document.getElementById("allBtn").classList.add("active");
    renderCards(filterCards());
});

// 設定モーダル
document.getElementById("settingsBtn").addEventListener("click", () => {
    const modal = new bootstrap.Modal(document.getElementById("settingsModal"));
    modal.show();
});

// Debugボタン
document.getElementById("debugToggleBtn").addEventListener("click", () => {
    debugMode = !debugMode;
    const btn = document.getElementById("debugToggleBtn");
    btn.textContent = debugMode ? "Debug ON" : "Debug OFF";
    btn.classList.toggle("active", debugMode);
    if (!debugMode) document.getElementById("debugOutput").textContent = "";
});

// Collected確認スイッチ
document.getElementById("confirmToggleBtn").addEventListener("click", () => {
    confirmOwnedRemoval = !confirmOwnedRemoval;
    const btn = document.getElementById("confirmToggleBtn");
    btn.textContent = confirmOwnedRemoval ? "Collected 確認 ON" : "Collected 確認 OFF";
    btn.classList.toggle("active", confirmOwnedRemoval);
});

// ---- 統計用ヘルパ ----
function addRow(tbody, cols, isTotal=false) {
  const tr = document.createElement('tr');
  if (isTotal) tr.classList.add('total-row');
  tr.innerHTML = cols.map(c => `<td>${c}</td>`).join('');
  tbody.appendChild(tr);
}

function buildRarityStats() {
  const rarityCounts = {};
  const rarityOwned  = {};
  cards.forEach(c => {
    const r = c.rarity || '未分類';
    rarityCounts[r] = (rarityCounts[r] || 0) + 1;
    if (isOwned(c)) rarityOwned[r] = (rarityOwned[r] || 0) + 1;
  });

  const tbody = document.querySelector('#rarityTable tbody');
  tbody.innerHTML = '';

  const order = [...RARITY_ORDER, "未分類"];
  const totalCards = Object.values(rarityCounts).reduce((a,b)=>a+b,0);
  const totalOwned = Object.keys(rarityCounts).reduce((acc,r)=>acc+(rarityOwned[r]||0),0);

  let percentSumWithin = 0;

  order.forEach(r => {
    if (!rarityCounts[r]) return;
    const totalIn = rarityCounts[r];
    const ownedIn = rarityOwned[r] || 0;
    const pctWithin = totalIn > 0 ? (ownedIn / totalIn * 100) : 0;
    percentSumWithin += pctWithin;
    addRow(tbody, [
      r,
      totalIn,
      ownedIn,
      `${pctWithin.toFixed(2)}%`
    ]);
  });

  addRow(tbody, [
    '合計',
    totalCards,
    totalOwned,
    `${percentSumWithin.toFixed(2)}%`
  ], true);
}

function buildColorStats() {
  const colorCounts = {};
  const colorOwned  = {};

  cards.forEach(c => {
    let colors = Array.isArray(c.color) ? c.color : (c.color ? [c.color] : []);
    if (colors.length === 0) colors = ['未設定'];
    colors.forEach(clr => {
      colorCounts[clr] = (colorCounts[clr] || 0) + 1;
      if (isOwned(c)) colorOwned[clr] = (colorOwned[clr] || 0) + 1;
    });
  });

  const tbody = document.querySelector('#colorTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const colors = Object.keys(colorCounts);

  let percentSumWithin = 0;
  let totalCards = 0;
  let totalOwned = 0;

  colors.forEach(clr => {
    const totalIn = colorCounts[clr];
    const ownedIn = colorOwned[clr] || 0;
    const pctWithin = totalIn > 0 ? (ownedIn / totalIn * 100) : 0;
    percentSumWithin += pctWithin;
    totalCards += totalIn;
    totalOwned += ownedIn;

    addRow(tbody, [
      clr,
      totalIn,
      ownedIn,
      `${pctWithin.toFixed(2)}%`
    ]);
  });

  addRow(tbody, [
    '合計',
    totalCards,
    totalOwned,
    `${percentSumWithin.toFixed(2)}%`
  ], true);
}

// ---- 統計モーダル表示更新 ----
document.getElementById('statsBtn').addEventListener('click', () => {
  buildRarityStats();
  buildColorStats();
});

const searchInputEl = document.getElementById("searchInput");

// 検索の自動更新 (inputイベント)
searchInputEl.addEventListener("input", () => {
    renderCards(filterCards());
    updateActiveFilters();
});

searchInputEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    searchInputEl.blur();
    renderCards(filterCards());
    updateActiveFilters();
  }
});

const clearBtn = document.getElementById("clearSearch");

clearBtn.addEventListener("click", () => {
  searchInputEl.value = "";
  searchInputEl.blur();
  renderCards(filterCards());
  updateActiveFilters();
});

let myChart = null;

const historyModalEl = document.getElementById('historyModal');
historyModalEl.addEventListener('show.bs.modal', (event) => {
    const button = event.relatedTarget;
    if (!button || !button.getAttribute('data-priceid')) {
        return;
    }
    const priceid = button.getAttribute('data-priceid');

    const card = cards.find(c => c.priceid === priceid);
    if (card) {
        document.getElementById('historyCardName').textContent = card.name || card.code || '';
    }

    const history = cMap[priceid];

    if (history) {
        const chartContainer = document.getElementById('chart-container');
        chartContainer.innerHTML = '<canvas id="historyChart"></canvas>';

        const dates = history.map(h => h.date);
        const prices = history.map(h => h.value);

        const ctx = document.getElementById('historyChart').getContext('2d');

        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: '価格',
                    data: prices,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: { color: 'white' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { color: 'white' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: 'white' }
                    }
                }
            }
        });
    }
});

historyModalEl.addEventListener('hide.bs.modal', () => {
  if (myChart) {
    myChart.destroy();
    myChart = null;
  }
});

document.getElementById("exportDataBtn").addEventListener("click", () => {
    const data = {};
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("normal_") || key.startsWith("don_")) {
            data[key] = localStorage.getItem(key);
        }
    }
    const jsonString = JSON.stringify(data, null, 2);

    const outputArea = document.getElementById("dataOutput");
    const copyBtn = document.getElementById("copyDataBtn");

    outputArea.value = jsonString;
    outputArea.style.display = "block";
    copyBtn.style.display = "block";
    outputArea.select();
});

document.getElementById("copyDataBtn").addEventListener("click", () => {
    const outputArea = document.getElementById("dataOutput");
    outputArea.select();
    navigator.clipboard.writeText(outputArea.value)
        .then(() => {
            alert("データをクリップボードにコピーしました！");
        })
        .catch(err => {
            console.error("コピーに失敗しました:", err);
            alert("コピーに失敗しました。お手数ですが手動でコピーしてください。");
        });
});

document.getElementById("importDataBtn").addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".json";
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key.startsWith("normal_") || key.startsWith("don_")) {
                        localStorage.removeItem(key);
                    }
                }
                for (const key in importedData) {
                    localStorage.setItem(key, importedData[key]);
                }
                alert("コレクションデータのインポートが完了しました！");
                renderCards(filterCards());
            } catch (err) {
                alert("データのインポートに失敗しました。有効なJSONバックアップファイルか確認してください。");
                console.error(err);
            }
        };
        reader.readAsText(file);
    };
    input.click();
});
</script>
</body>
</html>
